name: ZenovaAPI Build

on:
  workflow_call:

jobs:
  build:
    # Currently only supports x64 due to the state of the project
    name: Windows x64 Build
    runs-on: windows-latest

    steps:
    - name: Setup NASM
      uses: ilammy/setup-nasm@v1
    - name: Git Checkout
      uses: actions/checkout@v2

    # Remove? I'm not sure how to properly utilize this
    - name: Restore CMake Cache
      uses: actions/cache@v2
      with:
        path: build/
        key: ${{ github.ref_name }}-cxx-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ github.ref_name }}-cxx-

    - name: Run CMake and Build
      run: |
        cmake -B build -S . -A x64
        cmake --build build --config Release

    - name: Setup Artifact Uploads
      run: |
        New-Item -Type Directory dev\lib; 
        Copy-Item build\ZenovaAPI.lib dev\lib\; Move-Item inc dev
        New-Item -Type Directory artifact; 
        Copy-Item build\* artifact\ -Include "ZenovaAPI.dll", "ZenovaAPI.exp", "ZenovaAPI.lib"

    - name: Upload Development Package
      uses: actions/upload-artifact@v2
      with:
        name: ZenovaAPI-dev
        path: dev/

    - name: Upload x64 Build
      uses: actions/upload-artifact@v2
      with:
        name: ZenovaAPI
        path: artifact/
